@model IEnumerable<AGIMaster.Models.Product>
@{
    ViewBag.Title = "MakeOrder";
}

<h2>@ViewBag.Message</h2>

<h3> This is where you can make an Order</h3>
<table id="orders">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var product in Model.OrderBy(x => x.Id))
        {
            <tr id="@product.Id" data-name="@product.Name" data-price="@product.Price"><td>@product.Name</td><td>@product.Description</td><td>@product.Price</td></tr>
        }
    </tbody>
</table>
<div id="form">
    <h2>Click the items you want.</h2>
    <br />
    <table id="items">
        <thead>
            <tr>
                <th>
                    Product
                </th>
                <th>
                    Quantity
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <h3>Total: $<span id="price"></span></h3>
    <button type="button" id="formSubmit">Submit</button>
</div>
<script type="text/javascript">
    var inTable = new Array();
    var dupFlag = false;
    var totalPrice = 0.0;
    $(document).on("ready", function () {     
        $("#orders tbody tr").on("click", function () {
            var id = $(this).attr("id");
            if (inTable.length > 0) {
                for (i = 0; i < inTable.length; i++) {
                    if (inTable[i] == id) {
                        dupFlag = true;
                    }
                }
            }
            if (dupFlag) {
                var dup = $("table#items tr[ id=\"" + id + "\"]");
                var value = parseInt($(dup).find("td input").val()) +1;
                $(dup).find("td input").attr("value", value);

                totalPrice += parseFloat($(dup).data("price")) * value;
                dupFlag = false;
            } else {
                inTable[inTable.length] = id;
               // console.log("click");
                var newRow = "<tr id=\"" + id + "\"><td>" + $(this).data("name") + "</td><td><input type=\"number\" value=\"1\" /></td><td><span id=\""+id+"\">Delete</span></td></tr>";
               // console.log(newRow);
                $("table#items tbody").append(newRow);
                totalPrice += parseFloat($(this).data("price")) * parseInt($(this).find("td input").val());

            }
            console.log(totalPrice);
            $("span#price").text(totalPrice);

        });
        $("div#form button#formSubmit").on("click", function () {
            var products;
            var quantities;
            var counter = 0;
            $("table#items > tbody > tr").each(function () {
                if (counter == 0) {
                    products = $(this).attr("id");
                    quantities = $(this).find("input").attr("value");
                }
                else {
                    products += "," + $(this).attr("id");
                    quantities += "," + $(this).find("input").attr("value");
                }
                counter++;
            });
            // alert("Before aJax");
            console.log("Products: "+products+"\nQuantities: "+quantities);
            $.ajax({
                url: "@Url.Action("CreateOrder", "Orders")",
                type:"POST",
                data: {
                    products: products,
                    quantities: quantities
                },
                success: function(data) {
                   // alert("Submitted");
                    window.location = "/Orders/Orders";
                },
                error: function(e){
                    alert("ERROR\nProducts: "+products+"\nQuantities: "+quantities);
                    console.log(e.error());
                   // debugger;
                }
            });
            counter = 0;
            products = "";
            quantities = "";
        });
    });
</script>